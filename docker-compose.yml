version: '3.9'
services:
  protobuf_gen:
    build:
      context: .
      dockerfile: protobuf_gen-dockerfile
    working_dir: /app/packages/grpcapi
    volumes:
      - ./packages/grpcapi:/app/packages/grpcapi
      - ./packages/grpcapi/buf.yaml:/app/buf.yaml
      - ./packages/grpcapi/buf.gen.yaml:/app/packages/grpcapi/buf.gen.yaml
    command: [ "generate" ]
    profiles: [ "tools" ]
  postgres:
    build:
      context: .
      dockerfile: postgres-dockerfile
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - ./data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    
  redis:
    image: redis:latest
    container_name: redis_container
    volumes:
      - ./redisdata:/data
    command: >
      sh -c '
        mkdir -p /usr/local/etc/redis &&
        echo "bind 0.0.0.0" > /usr/local/etc/redis/redis.conf &&
        redis-server /usr/local/etc/redis/redis.conf
      '
  aggregation_server:
    build:
      context: .
      dockerfile: aggregation_server-dockerfile
    ports:
      - "8080:8080"
    depends_on:
      - aggregator
  aggregator:
    build:
      context: .
      dockerfile: aggregator-dockerfile
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_HOST: ${POSTGRES_HOST}
      POSTGRES_PORT: ${POSTGRES_PORT}
      REDIS_PORT: ${REDIS_PORT}
    ports:
      - "8081:8081"
    depends_on:
      - postgres
      - redis
